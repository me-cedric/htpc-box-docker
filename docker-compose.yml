networks:
  default:
    driver: bridge
  nextcloud:
    name: nextcould
    driver: bridge
  npm_proxy:
    name: npm_proxy
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.89.0/24

x-common-keys-media: &common-keys-media
  networks:
    - npm_proxy
  restart: unless-stopped
  # prevents any process within the container to gain more privileges
  security_opt:
    - "no-new-privileges=true"

volumes:
  nextcloud_aio_mastercontainer:
    name: nextcloud_aio_mastercontainer

secrets:
  tfa_config:
    file: tfa-config.yaml

services:
  ############################
  # Traefik
  ############################
  traefik:
    container_name: traefik
    image: traefik:latest
    <<: *common-keys-media
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.100
    ports:
      - 80:80
      - 443:443
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - "./letsencrypt:/letsencrypt"
    environment:
      - TZ=$TZ
    command:
      - --api
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --serverstransport.insecureskipverify=true
      - "--certificatesresolvers.letsencrypt.acme.email=${EMAIL}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${SERVERNAME}`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.middlewares=sanitize-headers,forward-auth,auth-admin"
      # Redirect HTTP â†’ HTTPS
      - "traefik.http.routers.http-catchall.rule=hostregexp(`{host:.+}`)"
      - "traefik.http.routers.http-catchall.entrypoints=web"
      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      # Sanitize any client headers before auth
      - "traefik.http.middlewares.sanitize-headers.headers.customrequestheaders.X-Forwarded-User="
      - "traefik.http.middlewares.sanitize-headers.headers.customrequestheaders.X-Forwarded-Email="
      - "traefik.http.middlewares.sanitize-headers.headers.customrequestheaders.X-Forwarded-Groups="
      # User or admin access (user + credentials-admin)
      - "traefik.http.middlewares.auth-user.headers.customrequestheaders.X-Auth-Group=%{X-Forwarded-Groups}"
      - "traefik.http.middlewares.auth-user.headers.customresponseheaders.Access-Control-Allow-Origin=*"
      - "traefik.http.middlewares.auth-user.headers.customresponseheaders.Access-Control-Allow-Credentials=true"
      # Admin access only (credentials-admin)
      - "traefik.http.middlewares.auth-admin.headers.customrequestheaders.X-Auth-Group=%{X-Forwarded-Groups}"
    depends_on:
      - traefik-forward-auth

  ############################
  # traefik-forward-auth plugin
  ############################
  traefik-forward-auth:
    container_name: traefik-forward-auth
    image: ghcr.io/italypaleale/traefik-forward-auth:latest
    <<: *common-keys-media
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.116
    ports:
      - "4181"
    secrets:
      # Load the configuration from the secret
      - source: "tfa_config"
        target: "/etc/traefik-forward-auth/config.yaml"
    volumes:
      - ./tfa-config.yaml.template:/etc/traefik-forward-auth/tfa-config.yaml.template:ro
    labels:
      # ForwardAuth: authentication
      - "traefik.http.middlewares.forward-auth.forwardauth.address=http://traefik-forward-auth:4181/forward/portals/homarr"
      - "traefik.http.middlewares.forward-auth.forwardauth.trustforwardheader=true"
      - "traefik.http.middlewares.forward-auth.forwardauth.authresponseheaders=X-Forwarded-User,X-Forwarded-Email,X-Forwarded-Groups,X-Forwarded-Displayname,X-Authenticated-User,X-Forwarded-For,X-Forwarded-Proto"
      - "traefik.enable=true"
      - "traefik.http.routers.forward-auth.rule=Host(`auth.${SERVERNAME}`) && PathPrefix(`/forward`)"
      - "traefik.http.routers.forward-auth.entrypoints=websecure"
      - "traefik.http.routers.forward-auth.tls=true"
      - "traefik.http.routers.forward-auth.tls.certresolver=letsencrypt"
      - "traefik.http.routers.forward-auth.service=forward-auth"
      - "traefik.http.services.forward-auth.loadbalancer.server.port=4181"

  ############################
  # Pocket ID (OIDC IdP)
  ############################
  pocketid:
    container_name: pocketid
    image: ghcr.io/pocket-id/pocket-id:latest
    ports:
      - "1411"
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.114
    <<: *common-keys-media
    volumes:
      - ${CONFIG}/pocketid/data:/app/data
    environment:
      - TZ=${TZ}
      - TRUST_PROXY=true
      - APP_URL=https://auth.${SERVERNAME}
      - COOKIE_DOMAIN=.${SERVERNAME}
      - COOKIE_SECURE=true
      - ENCRYPTION_KEY=${ENCRYPTIONKEY}
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.pocketid.rule=Host(`auth.${SERVERNAME}`)"
      - "traefik.http.routers.pocketid.entrypoints=websecure"
      - "traefik.http.routers.pocketid.tls=true"
      - "traefik.http.routers.pocketid.tls.certresolver=letsencrypt"
      - "traefik.http.routers.pocketid.service=pocketid"
      - "traefik.http.services.pocketid.loadbalancer.server.port=1411"
    depends_on:
      - traefik

  ############################
  # Homarr (OIDC login, internal role mapping)
  ############################
  homarr:
    container_name: homarr
    image: ghcr.io/homarr-labs/homarr:latest
    ports:
      - "7575"
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.113
    <<: *common-keys-media
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${CONFIG}/homarr/appdata:/appdata
    environment:
      TZ: ${TZ}
      PUID: ${PUID}
      PGID: 996
      SECRET_ENCRYPTION_KEY: ${ENCRYPTIONKEY} # can be generated with `openssl rand -hex 32`
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.homarr.rule=Host(`homarr.${SERVERNAME}`)"
      - "traefik.http.routers.homarr.middlewares=sanitize-headers,forward-auth,auth-user"
      - "traefik.http.routers.homarr.entrypoints=websecure"
      - "traefik.http.routers.homarr.tls=true"
      - "traefik.http.routers.homarr.tls.certresolver=letsencrypt"
      - "traefik.http.routers.homarr.service=homarr"
      - "traefik.http.services.homarr.loadbalancer.server.port=7575"
    depends_on:
      - traefik

  ############################
  # Seerr (user group)
  ############################
  seerr:
    image: ghcr.io/seerr-team/seerr:latest
    init: true
    container_name: seerr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - LOG_LEVEL=debug
      - TZ=${TZ}
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.112
    ports:
      - 5055:5055
    volumes:
      - ${CONFIG}/seerr:/app/config
    restart: unless-stopped
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.seerr.rule=Host(`seerr.${SERVERNAME}`)"
      - "traefik.http.routers.seerr.middlewares=sanitize-headers,forward-auth,auth-user"
      - "traefik.http.routers.seerr.entrypoints=websecure"
      - "traefik.http.routers.seerr.tls=true"
      - "traefik.http.routers.seerr.tls.certresolver=letsencrypt"
      - "traefik.http.routers.seerr.service=seerr"
      - "traefik.http.services.seerr.loadbalancer.server.port=5055"
    depends_on:
      - traefik

  ############################
  # Truenas behind Nginx (admin group)
  ############################
  nginx:
    image: nginx:latest
    container_name: truenas
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.101
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/nginx.conf
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.nginx.rule=Host(`truenas.${SERVERNAME}`)"
      - "traefik.http.routers.nginx.middlewares=sanitize-headers,forward-auth,auth-admin"
      - "traefik.http.routers.nginx.entrypoints=websecure"
      - "traefik.http.routers.nginx.tls=true"
      - "traefik.http.routers.nginx.tls.certresolver=letsencrypt"
      - "traefik.http.routers.nginx.service=nginx"
      - "traefik.http.services.nginx.loadbalancer.server.port=8081"
      - "traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto=http"
    depends_on:
      - traefik

  ############################
  # Portainer (admin group)
  ############################
  portainer:
    image: portainer/portainer-ce:latest
    command: -H unix:///var/run/docker.sock
    container_name: portainer
    <<: *common-keys-media
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.102
    security_opt:
      - no-new-privileges:true
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./portainer-data:/data
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`portainer.${SERVERNAME}`)"
      - "traefik.http.routers.portainer.middlewares=sanitize-headers,forward-auth,auth-admin"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls=true"
      - "traefik.http.routers.portainer.tls.certresolver=letsencrypt"
      - "traefik.http.routers.portainer.service=portainer"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"
    depends_on:
      - traefik

  ############################
  # Watchtower (no UI)
  ############################
  watchtower:
    container_name: watchtower
    image: nickfedor/watchtower:latest
    restart: unless-stopped
    command: --interval 43200
    labels:
      - com.centurylinklabs.watchtower.enable=true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  ############################
  # NordVPN that exposes Deluge web UI (admin group)
  ############################
  nordvpn:
    container_name: nordvpn
    image: azinchen/nordvpn:4.1.0
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.160
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - /dev/net/tun
    environment:
      - USER=${VPN_USER}
      - PASS=${VPN_PWD}
      - COUNTRY=${VPN_COUNTRY}
      - GROUP=Standard VPN servers
      - RANDOM_TOP=10
      #      - RECREATE_VPN_CRON=5 */3 * * *
      - NETWORK=${NETWORK}
      - OPENVPN_OPTS=--mute-replay-warnings
      - TZ=${TZ}
    ports:
      - 8112:8112
      - 8123:8123
      - 58846:58846
      - 58946:58946
      - 6881:6881
      - 6881:6881/udp
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.deluge.rule=Host(`deluge.${SERVERNAME}`)"
      - "traefik.http.routers.deluge.middlewares=sanitize-headers,forward-auth,auth-admin"
      - "traefik.http.routers.deluge.entrypoints=websecure"
      - "traefik.http.routers.deluge.tls=true"
      - "traefik.http.routers.deluge.tls.certresolver=letsencrypt"
      - "traefik.http.routers.deluge.service=deluge"
      - "traefik.http.services.deluge.loadbalancer.server.port=8112"
      - "traefik.http.routers.qbittorrent.rule=Host(`qbittorrent.${SERVERNAME}`)"
      - "traefik.http.routers.qbittorrent.middlewares=sanitize-headers,forward-auth,auth-admin"
      - "traefik.http.routers.qbittorrent.entrypoints=websecure"
      - "traefik.http.routers.qbittorrent.tls=true"
      - "traefik.http.routers.qbittorrent.tls.certresolver=letsencrypt"
      - "traefik.http.routers.qbittorrent.service=qbittorrent"
      - "traefik.http.services.qbittorrent.loadbalancer.server.port=8123"
    depends_on:
      - traefik

  ############################
  # Qbittorrent (behind NordVPN)
  ############################
  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    network_mode: service:nordvpn
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - DOCKER_MODS=ghcr.io/themepark-dev/theme.park:qbittorrent
      - TP_THEME=dracula
      - WEBUI_PORT=8123
      - TORRENTING_PORT=6881
    volumes:
      - ${CONFIG}/qbittorrent:/config
      - ${ROOT}/downloads:/downloads
    depends_on:
      - traefik
      - nordvpn

  ############################
  # Radarr (admin group)
  ############################
  radarr:
    image: linuxserver/radarr:latest
    container_name: radarr
    ports:
      - "7878"
    <<: *common-keys-media
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.104
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - DOCKER_MODS=ghcr.io/themepark-dev/theme.park:radarr
      - TP_THEME=overseerr
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${CONFIG}/radarr:/config
      - ${ROOT}/movies:/movies
      - ${ROOT}/downloads:/downloads
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.radarr.rule=Host(`radarr.${SERVERNAME}`)"
      - "traefik.http.routers.radarr.middlewares=sanitize-headers,forward-auth,auth-admin"
      - "traefik.http.routers.radarr.entrypoints=websecure"
      - "traefik.http.routers.radarr.tls=true"
      - "traefik.http.routers.radarr.tls.certresolver=letsencrypt"
      - "traefik.http.routers.radarr.service=radarr"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"
    depends_on:
      - traefik

  ############################
  # Sonarr (admin group)
  ############################
  sonarr:
    image: linuxserver/sonarr:latest
    container_name: sonarr
    ports:
      - "8989"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - DOCKER_MODS=ghcr.io/themepark-dev/theme.park:sonarr
      - TP_THEME=overseerr
    <<: *common-keys-media
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.105
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${CONFIG}/sonarr:/config
      - ${ROOT}/tv:/tv
      - ${ROOT}/downloads:/downloads
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.${SERVERNAME}`)"
      - "traefik.http.routers.sonarr.middlewares=sanitize-headers,forward-auth,auth-admin"
      - "traefik.http.routers.sonarr.entrypoints=websecure"
      - "traefik.http.routers.sonarr.tls=true"
      - "traefik.http.routers.sonarr.tls.certresolver=letsencrypt"
      - "traefik.http.routers.sonarr.service=sonarr"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"
    depends_on:
      - traefik

  swaparr-radarr:
    image: ghcr.io/thijmengthn/swaparr:latest
    container_name: swaparr-radarr
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.117
    restart: always
    environment:
      - BASEURL=http://192.168.89.104:7878 # IP or FQDN           (Required)
      - APIKEY=eb4e4bfd01f043d193b38ef0056db553 # Radarr API Key       (Required)                
      - PLATFORM=radarr               # "radarr", "sonarr".. (Optional) default: radarr
      - TIME_THRESHOLD=2h             # 1d, 6h, 30m, etc..   (Optional) default: 2h    
      - SIZE_THRESHOLD=25GB           # 1TB, 1GB, 1MB, etc.. (Optional) default: 25GB  
      - CHECK_INTERVAL=10m            # 1d, 6h, 30m, etc..   (Optional) default: 10m   
      - STRIKE_THRESHOLD=3            # Positive number      (Optional) default: 3     
      - AGGRESSIVE_STRIKES=true      # Boolean              (Optional) default: false 

  swaparr-sonarr:
    image: ghcr.io/thijmengthn/swaparr:latest
    container_name: swaparr-sonarr
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.118
    restart: always
    environment:
      - BASEURL=http://192.168.89.105:8989 # IP or FQDN           (Required)
      - APIKEY=b314d1846b994120bc2b144279b4ae78 # Sonarr API Key       (Required)                
      - PLATFORM=sonarr               # "radarr", "sonarr".. (Optional) default: radarr
      - TIME_THRESHOLD=2h             # 1d, 6h, 30m, etc..   (Optional) default: 2h    
      - SIZE_THRESHOLD=25GB           # 1TB, 1GB, 1MB, etc.. (Optional) default: 25GB  
      - CHECK_INTERVAL=10m            # 1d, 6h, 30m, etc..   (Optional) default: 10m   
      - STRIKE_THRESHOLD=3            # Positive number      (Optional) default: 3     
      - AGGRESSIVE_STRIKES=true      # Boolean              (Optional) default: false

  ############################
  # Plex (open access)
  ############################
  plex-server:
    image: linuxserver/plex:latest
    container_name: plex-server
    restart: unless-stopped
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.106
    ports:
      - target: 32400
        published: 32400
        protocol: tcp
        mode: host
      - target: 32400
        published: 32400
        protocol: udp
        mode: host
    ulimits:
      sigpending: 62793
      nproc: 131072
      nofile: 60000
      core: 0
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - VERSION=docker
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,video,utility
      # Only on first boot
      # - PLEX_CLAIM=${PLEX_CLAIM}
    volumes:
      - ${CONFIG}/plex/library:/root/Library
      - ${CONFIG}/plex/db:/config
      - ${CONFIG}/plex/transcode:/transcode
      - ${ROOT}/tv:/data/tvshows
      - ${ROOT}/movies:/data/movies
    labels:
      - com.centurylinklabs.watchtower.enable=true- "traefik.enable=true"
      - "traefik.enable=true"
      - "traefik.http.routers.plex-server.rule=Host(`plex.${SERVERNAME}`)"
      - "traefik.http.routers.plex-server.entrypoints=websecure"
      - "traefik.http.routers.plex-server.tls=true"
      - "traefik.http.routers.plex-server.tls.certresolver=letsencrypt"
      - "traefik.http.routers.plex-server.service=plex-server"
      - "traefik.http.services.plex-server.loadbalancer.server.port=32400"
    depends_on:
      - traefik

  ############################
  # Ofelia to schedule Plex and Trakt sync every 6h (no UI)
  ############################
  scheduler:
    image: mcuadros/ofelia:latest
    container_name: scheduler
    depends_on:
      - plextraktsync
      - plex-server
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.107
    command: daemon --docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      ofelia.job-run.plextraktsync.schedule: "@every 6h"
      ofelia.job-run.plextraktsync.container: "plextraktsync"

  ############################
  # PlexTraktSync (no UI)
  ############################
  # run `docker-compose run --rm plextraktsync sync` before running compose to setup credentials
  plextraktsync:
    image: ghcr.io/taxel/plextraktsync
    command: sync
    container_name: plextraktsync
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.108
    restart: on-failure:2
    volumes:
      - ${CONFIG}/plextraktsync:/app/config
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
    labels:
      - com.centurylinklabs.watchtower.enable=true
    depends_on:
      - plex-server

  ############################
  # Bazarr (admin group)
  ############################
  bazarr:
    image: linuxserver/bazarr:latest
    container_name: bazarr
    <<: *common-keys-media
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.110
    ports:
      - "6767"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - DOCKER_MODS=ghcr.io/themepark-dev/theme.park:bazarr
      - TP_THEME=overseerr
    volumes:
      - ${CONFIG}/bazarr:/config
      - ${ROOT}/movies:/movies
      - ${ROOT}/tv:/tv
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.bazarr.rule=Host(`bazarr.${SERVERNAME}`)"
      - "traefik.http.routers.bazarr.middlewares=sanitize-headers,forward-auth,auth-admin"
      - "traefik.http.routers.bazarr.entrypoints=websecure"
      - "traefik.http.routers.bazarr.tls=true"
      - "traefik.http.routers.bazarr.tls.certresolver=letsencrypt"
      - "traefik.http.routers.bazarr.service=bazarr"
      - "traefik.http.services.bazarr.loadbalancer.server.port=6767"
    depends_on:
      - traefik

  ############################
  # Flaresolverr (admin group)
  ############################
  flaresolverr:
    container_name: flaresolverr
    image: ghcr.io/flaresolverr/flaresolverr:latest
    restart: unless-stopped
    <<: *common-keys-media
    ports:
      - "8191"
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.166
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG}/flaresolverr:/config
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.flaresolverr.rule=Host(`flaresolverr.${SERVERNAME}`)"
      - "traefik.http.routers.flaresolverr.middlewares=sanitize-headers,forward-auth,auth-admin"
      - "traefik.http.routers.flaresolverr.entrypoints=websecure"
      - "traefik.http.routers.flaresolverr.tls=true"
      - "traefik.http.routers.flaresolverr.tls.certresolver=letsencrypt"
      - "traefik.http.routers.flaresolverr.service=flaresolverr"
      - "traefik.http.services.flaresolverr.loadbalancer.server.port=8191"
    depends_on:
      - traefik

  ############################
  # Duplicati (admin group)
  ############################
  duplicati:
    container_name: duplicati
    image: linuxserver/duplicati:latest
    restart: unless-stopped
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.168
    ports:
      - "8200"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - DOCKER_MODS=ghcr.io/themepark-dev/theme.park:duplicati
      - TP_THEME=overseerr
      - DUPLICATI__WEBSERVICE_PASSWORD=${DUPLICATI__WEBSERVICE_PASSWORD}
    volumes:
      - ${CONFIG}/duplicati:/config
      - ${CONFIG}:/source
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.duplicati.rule=Host(`duplicati.${SERVERNAME}`)"
      - "traefik.http.routers.duplicati.middlewares=sanitize-headers,forward-auth,auth-admin"
      - "traefik.http.routers.duplicati.entrypoints=websecure"
      - "traefik.http.routers.duplicati.tls=true"
      - "traefik.http.routers.duplicati.tls.certresolver=letsencrypt"
      - "traefik.http.routers.duplicati.service=duplicati"
      - "traefik.http.services.duplicati.loadbalancer.server.port=8200"
    depends_on:
      - traefik

  ############################
  # MariaDB for Nextcloud (not exposed)
  ############################
  database:
    image: mariadb:10
    container_name: database
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
    networks:
      - nextcloud
    volumes:
      - ${CONFIG}/mariadb:/var/lib/mysql

  ############################
  # Redis for Nextcloud (not exposed)
  ############################
  redis:
    image: redis:alpine
    container_name: redis
    networks:
      nextcloud:
    restart: unless-stopped

  ############################
  # Nextcloud (admin group)
  ############################
  nextcloud:
    image: nextcloud:latest
    container_name: nextcloud
    restart: unless-stopped
    depends_on:
      - database
      - redis
      - traefik
    hostname: nextcloud.${SERVERNAME}
    volumes:
      - ${CONFIG}/nextcloud:/var/www/html
      - ${ROOT}:/nas-share
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.170
      nextcloud:
    environment:
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_HOST=database
      - REDIS_HOST=redis
      - "NEXTCLOUD_TRUSTED_DOMAINS=localhost 0.0.0.0 192.168.89.0 ${SERVERNAME} organizr.${SERVERNAME} nextcloud.${SERVERNAME}"
      - TRUSTED_PROXIES=192.168.89.0/24
      - OVERWRITEPROTOCOL=https
    ports:
      - 8282:80
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.nextcloud.rule=Host(`nextcloud.${SERVERNAME}`)"
      - "traefik.http.routers.nextcloud.middlewares=auth-admin@docker,sanitize-headers,forward-auth,nextcloud-dav,nextcloud-headers"
      - "traefik.http.routers.nextcloud.entrypoints=websecure"
      - "traefik.http.routers.nextcloud.tls=true"
      - "traefik.http.routers.nextcloud.tls.certresolver=letsencrypt"
      - "traefik.http.routers.nextcloud.service=nextcloud"
      - "traefik.http.middlewares.nextcloud-dav.replacepathregex.regex=^/.well-known/ca(l|rd)dav"
      - "traefik.http.middlewares.nextcloud-dav.replacepathregex.replacement=/remote.php/dav/"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsSeconds=15552000"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.nextcloud-headers.headers.forceSTSHeader=true"
      - "traefik.http.services.nextcloud.loadbalancer.server.port=80"
      - "traefik.docker.network=npm_proxy"

  ############################
  # Kavita (admin group)
  ############################
  kavita:
    image: jvmilazz0/kavita:latest
    container_name: kavita
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.171
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG}/kavita:/kavita/config
      - ${ROOT}/ebooks/comics:/comics
      - ${ROOT}/ebooks/bd:/bd
      - ${ROOT}/ebooks/books:/books
      - ${ROOT}/ebooks/manga:/manga
    ports:
      - "5000"
    restart: unless-stopped
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.kavita.rule=Host(`kavita.${SERVERNAME}`)"
      - "traefik.http.routers.kavita.middlewares=sanitize-headers,forward-auth,auth-admin"
      - "traefik.http.routers.kavita.entrypoints=websecure"
      - "traefik.http.routers.kavita.tls=true"
      - "traefik.http.routers.kavita.tls.certresolver=letsencrypt"
      - "traefik.http.routers.kavita.service=kavita"
      - "traefik.http.services.kavita.loadbalancer.server.port=5000"
    depends_on:
      - traefik

  ############################
  # Prowlarr (admin group)
  ############################
  prowlarr:
    image: linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - DOCKER_MODS=ghcr.io/themepark-dev/theme.park:prowlarr
      - TP_THEME=overseerr
    ports:
      - "9696"
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.172
    volumes:
      - ${CONFIG}/prowlarr:/config
    restart: unless-stopped
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.prowlarr.rule=Host(`prowlarr.${SERVERNAME}`)"
      - "traefik.http.routers.prowlarr.middlewares=sanitize-headers,forward-auth,auth-admin"
      - "traefik.http.routers.prowlarr.entrypoints=websecure"
      - "traefik.http.routers.prowlarr.tls=true"
      - "traefik.http.routers.prowlarr.tls.certresolver=letsencrypt"
      - "traefik.http.routers.prowlarr.service=prowlarr"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"
    depends_on:
      - traefik
      - radarr
      - sonarr
      - flaresolverr

  ############################
  # Tdarr (admin group)
  ############################
  tdarr:
    container_name: tdarr
    image: ghcr.io/haveagitgat/tdarr:latest
    restart: unless-stopped
    ports:
      - "8265" # webUI port
      - "8266" # server port
    networks:
      npm_proxy:
        ipv4_address: 192.168.89.173
    environment:
      - TZ=${TZ}
      - PUID=${PUID}
      - PGID=${PGID}
      - UMASK_SET=002
      - serverIP=0.0.0.0
      - serverPort=8266
      - webUIPort=8265
      - internalNode=true
      - inContainer=true
      - ffmpegVersion=6
      - nodeName=TdarrInternalNode
      - NVIDIA_DRIVER_CAPABILITIES=all
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - ${CONFIG}/tdarr/server:/app/server
      - ${CONFIG}/tdarr/configs:/app/configs
      - ./logs/tdarr:/app/logs
      - ${ROOT}/movies:/media/movies
      - ${ROOT}/tv:/media/tv
      - ./transcode_cache:/temp
    devices:
      - /dev/dri:/dev/dri
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - "traefik.enable=true"
      - "traefik.http.routers.tdarr.rule=Host(`tdarr.${SERVERNAME}`)"
      - "traefik.http.routers.tdarr.middlewares=sanitize-headers,forward-auth,auth-admin"
      - "traefik.http.routers.tdarr.entrypoints=websecure"
      - "traefik.http.routers.tdarr.tls=true"
      - "traefik.http.routers.tdarr.tls.certresolver=letsencrypt"
      - "traefik.http.routers.tdarr.service=tdarr"
      - "traefik.http.services.tdarr.loadbalancer.server.port=8265"
    depends_on:
      - traefik

  ############################
  # Clawdbot - AI Assistant
  ############################
#  clawdbot:
#    container_name: clawdbot
#    image: clawdbot:local
#    command: ["node", "dist/index.js", "gateway"]
#    ports:
#      - "18789:18789"
#    networks:
#      npm_proxy:
#        ipv4_address: 192.168.89.115
#    <<: *common-keys-media
#    environment:
#      - PUID=${PUID}
#      - PGID=${PGID}
#      - TZ=${TZ}
#      - HOME=/home/node
#      - TERM=xterm-256color
#      - BROWSER=echo
#    volumes:
#      - ${CONFIG}/clawdbot:/home/node/.clawdbot
#      - ${ROOT}/clawdbot-workspace:/home/node/clawd
#      - /var/run/docker.sock:/var/run/docker.sock:ro
#    labels:
#      - com.centurylinklabs.watchtower.enable=true
#      - "traefik.enable=true"
#      - "traefik.http.routers.clawdbot.rule=Host(`clawdbot.${SERVERNAME}`)"
#      - "traefik.http.routers.clawdbot.middlewares=sanitize-headers"
#      - "traefik.http.routers.clawdbot.entrypoints=websecure"
#      - "traefik.http.routers.clawdbot.tls=true"
#      - "traefik.http.routers.clawdbot.tls.certresolver=letsencrypt"
#      - "traefik.http.routers.clawdbot.service=clawdbot"
#      - "traefik.http.services.clawdbot.loadbalancer.server.port=18789"
#    depends_on:
#      - traefik
